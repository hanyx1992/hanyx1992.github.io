<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践 | 
        
        旭丶Joy
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="韩元旭">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content="">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="旭丶Joy">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践 | 旭丶Joy">
    <meta property="og:image" content="/img/favicon.png" />
    <meta property="og:description" content="">
    

    
        <meta property="article:published_time" content="7月 15, 2018" />
        <meta property="article:modified_time" content="7月 15, 2018" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践 | 旭丶Joy">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://yoursite.com" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/07/15/vision-demo/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "旭丶Joy",
        "logo": "/img/favicon.png"
    },
    "author": {
        "@type": "Person",
        "name": "韩元旭",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon.png"
        },
        "description": "Hi, nice to meet you"
    },
    "headline": "基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践",
    "url": "http://yoursite.com/2018/07/15/vision-demo/index.html",
    "datePublished": "7月 15, 2018",
    "dateModified": "7月 15, 2018",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://yoursite.com"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    
    
    .footer-sns-weibo {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzUuMiA3OWMtOC42IDMtMjIuOCAxMi40LTMyLjggMjEuOC04LjIgNy44LTIyLjIgMzEtMjQuNiA0MC42LTEgNC4yLTEuNiAxNjctMS42IDM2NC42IDAgMjg0LjguNCAzNTguNCAyLjYgMzY0IDEuNCAzLjggNi44IDEzIDEyIDIwLjQgOC44IDEyLjggMjQgMjUuNCA0MS44IDM1IDYgMy40IDI3IDMuNiAzNjcuNCAzLjYgMjg2LjIgMCAzNjIuNi0uNiAzNjktMi42IDE5LjgtNi4yIDUxLjItMzcuNiA1Ny40LTU3LjQgMi02LjQgMi42LTgyLjYgMi42LTM2OFYxNDFsLTQuMi05Yy0xMS42LTI0LTM5LjItNDkuOC01OC4yLTU0LjItNC4yLTEtMTY4LjYtMS42LTM2NS42LTEuNi0zMDAgMC0zNTkuMi40LTM2NS44IDIuOHptNTU4LjYgMTY5YzguNiAxLjIgMTYuNCA0IDI0IDguNiA2LjIgMy42IDE1LjIgOC4yIDIwLjIgMTAuMiA1LjggMi4yIDE0LjYgOC44IDI1IDE4LjggMjUuNCAyNC44IDMyLjggMzQuOCAzNy44IDUxIDIuNiA4IDcuNCAxOS44IDEwLjggMjYuNCA3LjggMTQuNiAxMS42IDQyLjYgOS40IDY5LTEgMTQuMi0yLjIgMTguNi03LjQgMjYuNC0zLjIgNS4yLTkgMTIuMi0xMi44IDE1LjYtMTMuOCAxMi0zNCA1LjgtMzguOC0xMi0xLjYtNi0xLjQtMTEuNCAxLjItMjMuNCA0LjItMjAgMy00Ni0yLjYtNTguNi0yLjItNS04LTEyLjYtMTIuOC0xNi44LTQuOC00LjItMTQuNi0xNi40LTIxLjgtMjYuOC03LjItMTAuNi0xNS4yLTIwLjgtMTgtMjIuOC0yLjgtMi0xMi42LTYtMjItOS0xNC40LTQuNC0yMC44LTUuNC00My01LjYtMjgtLjItMzEuNC0xLjItNDIuNC0xMS42LTcuNC03LTguNi0xNS42LTMuOC0yNS4yIDctMTMuMiAxNi40LTE2IDU0LjItMTYgMTYuNiAwIDM1LjguOCA0Mi44IDEuOHptLTIxMy42IDc1LjZjMjAuMiAxNS40IDIwLjYgMTYuNCAyMiA0OCAuNiAxNSAxLjggMjkgMi42IDMxIDIuOCA2LjIgMTEgNi42IDIxLjYuNiA1LjQtMy4yIDE0LTUuOCAyMC02LjQgNS44LS42IDE4LjgtMi40IDI5LTQuMiAxNy4yLTMgMTkuNC0zIDM2IC40IDMyIDYuNiAzNS44IDkuMiA0NC4yIDMxLjYgNS4yIDE0IDUuNCAyMS40IDEuMiAzMi44LTIuMiA1LjQtMi44IDExLTIgMTUuNCAxLjggMTAgMTcuNiAyMy40IDM1IDMwLjIgMTEuMiA0LjIgMTYuMiA3LjYgMjcgMTkgMTkuMiAxOS44IDIwLjIgMjMgMjAgNTktLjIgMzUtLjQgMzUuNC0xOS44IDYzLjYtMTMuOCAxOS44LTMyLjQgMzguNi00OSA1MC01IDMuNC0xMi4yIDguOC0xNS44IDEyLTMuOCAzLjItMTEuNiA4LTE3LjIgMTAuNC01LjYgMi42LTE0LjYgNy40LTE5LjggMTAuNi01LjIgMy40LTE1LjggNy42LTIzLjggOS40LTggMi0yMS4yIDYuNi0yOS42IDEwLjItMjIuNCAxMC0zNi4yIDExLjItMTIxLjggMTAuNGwtNzUtLjYtMTktOC40Yy0xMC42LTQuNi0yNS40LTkuOC0zMy0xMS42LTcuNi0xLjYtMTgtNS44LTIzLTlzLTE0LjItOC0yMC40LTEwLjhjLTE4LTgtNTkuNC00Ni4yLTY2LTYxLjItMi4yLTUtNy40LTE0LjQtMTEuNC0yMC44bC03LjItMTJWNTQ5bDcuNi0xMy42YzQuMi03LjQgOS40LTE4LjYgMTEuNi0yNC44IDMuOC0xMS40IDEzLjQtMjcuOCAyNC44LTQyLjYgMjAuMi0yNi4yIDM4LjQtNDYuOCA1My02MCA5LjItOC4yIDIxLTE4LjYgMjYtMjMuMiA1LTQuNCAxMy4yLTExIDE4LjYtMTQuNiA1LjItMy40IDkuNC03LjIgOS40LTggMC0xIDUuNi00LjYgMTIuNi04LjIgNi44LTMuOCAxNi40LTkuNiAyMS40LTEzLjIgNS0zLjYgMTQuNC04IDIxLTkuOCA2LjYtMiAxNy44LTYuNiAyNS0xMC4yIDEyLTYuMiAxNC40LTYuOCAzMi40LTYuOGgxOS40bDEyLjQgOS42em0yMDMuNiAxMy4yYzMgMS42IDYuNiA0LjQgOCA2IDEuNiAxLjggOS40IDcgMTcuNCAxMS42IDE3IDkuNiAxOSAxMyAyNCA0MiAzLjQgMjAuNCAyLjYgMzIuMi0zLjQgNDMuOC03LjYgMTUuMi0yMi44IDIwLjYtMzEuMiAxMS4yLTctNy42LTkuMi0xMy44LTEwLjYtMjkuNi0xLjItMTMuMi0yLjQtMTYuNC05LjYtMjcuMi0xMS0xNi0xNi44LTIwLjYtMjcuMi0yMC42LTEwIDAtMjQtNi4yLTI3LTExLjYtNS44LTEwLjguNC0yNC42IDEyLjQtMjguNCA4LjYtMi42IDQwLjItLjggNDcuMiAyLjh6Ii8+PHBhdGggZD0iTTQyNCA0NzcuNGMtMzIuNiAzLjYtNDcuOCA3LTYxLjggMTMuOC04IDQtMTkgOC40LTI0LjIgMTAtNS4yIDEuNi0xMi40IDUtMTYuMiA3LjgtMy44IDIuNi0xMSA3LjYtMTYuMiAxMS0xMy40IDguOC0zNSAzMy4yLTM4LjggNDQtMS44IDUtNS40IDE0LjQtOC4yIDIxLTguOCAyMS4yLTguMiAyNi44IDQgNTMgMTAuNiAyMi42IDExIDIzLjIgMjcuNiAzNi40IDIxIDE2LjggMjMuNiAxOC40IDUwLjggMjguMiAyMC4yIDcuMiAyNC42IDggNTQgMTAgMTcuNiAxLjIgNDUuNiAyLjIgNjIgMi4ybDMwIC4yIDE3LjQtOC40YzkuNi00LjYgMjIuNC05LjYgMjguMi0xMS40IDYtMS44IDE1LjQtNi4yIDIwLjgtMTAgNS40LTMuNiAxMy40LTguNiAxNy42LTEwLjggOS4yLTQuNiAzOS0zNC40IDM5LTM5IDAtMS42IDMuOC0xMC4yIDguNC0xOC44IDcuOC0xNC4yIDguNi0xNi44IDguNC0yOS42LS4yLTEyLjgtMS0xNS44LTEwLjYtMzQuNi0xMy40LTI2LjItMzAuNC00My42LTUwLjItNTEuNC03LjItMi44LTE2LjItNy0yMC05LjYtMTEuNC03LjYtMTcuNi05LjItNDguOC0xMi40LTI3LjYtMi44LTU2LjYtMy40LTczLjItMS42em0zOS40IDQ0LjRjMTEuMiAyLjIgMjIuNiA1IDI1IDYuNCA3IDMuNiAyNiAyMS44IDMwLjggMjkuNCA4LjYgMTMuNCAxMSA1NCA0LjYgNzctMi42IDkuNi0xOC44IDI3LjYtMzkuNCA0NC4yLTE1LjYgMTIuNC0xNyAxMy0yOS44IDE0LTcuNi44LTIyLjQgMi4yLTMzIDMuNi0yMi42IDIuNi00NS42IDEtNTMuOC0zLjgtMy4yLTItOC02LjgtMTAuOC0xMC44LTIuNi00LjItOC40LTEwLjQtMTIuOC0xMy44LTguMi02LjgtMTMuNC0xNi40LTE5LjQtMzctMy44LTEzLjItMi44LTIxLjggNS4yLTQ3LjYgMy4yLTEwLjQgNi0xNC42IDE3LjQtMjUuOCAxMi40LTEyLjIgMjMuOC0yMi4yIDMzLjItMjkuNiA0LTMgMzguNi05LjQgNTMuNC05LjggNSAwIDE4LjIgMS42IDI5LjQgMy42eiIvPjxwYXRoIGQ9Ik0zODcuMiA2MDZjLTEyLjIgMy44LTE4LjIgMTMuNC0xNSAyNC42IDUuOCAyMS4yIDI3LjggMjUuOCA0MC42IDguNiA2LjYtOC44IDcuOC0xNi4yIDQuMi0yNC00LjgtMTAuMi0xNS40LTEzLjQtMjkuOC05LjJ6Ii8+PC9zdmc+);
    }
    
    
    
    
    .footer-sns-github {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi40IDEuNC0yNi40IDE0LjItMzYgMjIuOC04IDcuMi0yMiAyOS44LTI0LjQgMzkuMi0xLjYgNi40LTIgMTEzLjItMS42IDM2OCAuNiAyOTkuNCAxIDM1OS44IDMuNCAzNjQgMTEgMjAuMiAyMS42IDMyLjQgMzcuMiA0MyAxNS42IDEwLjYgMTcuMiAxMS4yIDM0LjIgMTMuMiAxMC42IDEuMiA2My40IDEuNiAxMjcuNiAxLjRsMTA5LjYtLjYgNi02LjggNi4yLTYuOC0xLjItMjUuMmMtLjgtMTUuOC0uMi0zMy40IDEuNC00Ny4yIDMtMjUuNCAxLjQtMzYuMi02LTQzLjItNS00LjYtNi4yLTQuOC0zMC42LTQuMi0yNy42LjgtMjQgMS42LTY4LjgtMTYtOC42LTMuNC0yMi42LTE4LTI4LjQtMjkuOC0xMS40LTIyLjgtMjctNDUtMzkuMi01NS42LTE0LTEyLjItMTkuOC0yMC44LTE5LjgtMjguNiAwLTExLjYgMTMuNi0xMi42IDMzLjItMi40IDE2LjYgOC44IDIwLjggMTIuNCA0MC44IDM2LjIgMjQuMiAyOC42IDMxIDMzLjYgNTQgMzkuNiAxNS4yIDQgNDIuMiAzIDUxLjQtMS44IDktNC42IDE4LTE1LjIgMjQuNC0yOS4yIDExLjQtMjQuMiA3LjQtMzEuMi0yMC42LTM2LjgtOS44LTItMjkuMi04LTQzLjQtMTMuNC00MC40LTE1LjgtNjQuNi0zNy40LTg1LjQtNzYuMi0xMS42LTIxLjgtMTUuNC0zMy0xOC4yLTUzLjYtNC4yLTMyLjItNC44LTYwLjItMS40LTg0IDMuNC0yMy44IDYuOC0zMi44IDIwLjItNTQgNC02IDguOC0xNS42IDExLTIxLjQgMy44LTEwIDMuOC0xMS42IDEtMzAtNS4yLTM0LjItMy4yLTUyLjQgNy42LTcwLjIgNy4yLTEyLjIgMTUtMTcuMiAyNC4yLTE1LjggMTIuOCAyLjIgNTIgMTcuNCA2Ni44IDI2LjIgMjYgMTUgMjkgMTUuNCA4Mi40IDcuMiAyNC42LTMuOCAzMy44LTQuMiA2MC0zLjIgMTcgLjYgNDEuNCAzIDU0IDUuMiAzOC40IDYuNiA0OS42IDUuMiA3My0xMCA2LjYtNC4yIDE3LjQtOS40IDI0LTExLjYgNi42LTIuMiAxNi01LjggMjEtOC4yIDEzLTYgMjgtNS42IDM1LjYuOCAxMi40IDEwLjQgMTguNiA0MS40IDE0LjQgNzEuNi00LjQgMzAuNi0zIDM5LjQgOC40IDUzLjggMy40IDQuNCAxMS4yIDE5LjIgMTcuNCAzMy4yTDc3NSA0NDN2NzhsLTEwIDI4Yy0xNS4yIDQzLjItMzYuOCA3My4yLTY2LjIgOTIuOC0xMy40IDguOC01NyAyNS40LTc2LjggMjktMjguMiA1LjItMzMuMiAxMi42LTIyIDMyLjIgMTEuMiAxOS40IDEyLjQgMzIuOCAxMS42IDEyOS42bC0uNiA4NS44IDUuNCA0LjZjMy42IDMgOS4yIDUuMiAxNiA2IDUuOC44IDYwLjIgMSAxMjAuNi42IDEwOC40LS42IDExMC4yLS42IDExOS01IDI0LTExLjYgNDAtMjcuNCA1MS42LTUwLjZsNS40LTExIC42LTM0N2MuNC0yMjMtLjItMzUzLjQtMS40LTM2NS0yLTE3LTIuNi0xOC42LTEzLTM0LTEwLjYtMTUuNC0yMi44LTI2LjItNDMuMi0zNy4yLTQuMi0yLjQtNjQuNi0yLjgtMzY2LTMuMi0xOTguNiAwLTM2NCAuNC0zNjcuNiAxLjR6Ii8+PC9zdmc+);
    }
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#前面"><span class="post-toc-number">1.</span> <span class="post-toc-text">前面</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#功能点"><span class="post-toc-number">2.</span> <span class="post-toc-text">功能点</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#实现"><span class="post-toc-number">3.</span> <span class="post-toc-text">实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#搭建项目"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">搭建项目</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#自定义相机"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">自定义相机</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建相机会话"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">创建相机会话</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建相机预览层"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">创建相机预览层</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建人脸预览层"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">创建人脸预览层</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#会话控制"><span class="post-toc-number">3.2.4.</span> <span class="post-toc-text">会话控制</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#实时缓冲帧的获取"><span class="post-toc-number">3.2.5.</span> <span class="post-toc-text">实时缓冲帧的获取</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#拍照"><span class="post-toc-number">3.2.6.</span> <span class="post-toc-text">拍照</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#人脸追踪"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">人脸追踪</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#如何根据一张照片获取人脸位置"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">如何根据一张照片获取人脸位置?</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#获取缓冲帧照片"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">获取缓冲帧照片</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#实时显示人脸框"><span class="post-toc-number">3.3.3.</span> <span class="post-toc-text">实时显示人脸框</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#特征点提取"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">特征点提取</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#相似度匹配"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">相似度匹配</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#表情包制作"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">表情包制作</span></a></li></ol></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>韩元旭</strong>
        <span>7月 15, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践&url=http://yoursite.com/2018/07/15/vision-demo/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践&url=http://yoursite.com/2018/07/15/vision-demo/index.html&via=韩元旭" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/07/15/vision-demo/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2018/07/15/vision-demo/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=旭丶Joy&title=基于 iOS 11 Vision 的人脸识别和特征点提取的表情包模仿功能的实践&summary=&pics=http://yoursite.com/img/favicon.png&url=http://yoursite.com/2018/07/15/vision-demo/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="前面"><a href="#前面" class="headerlink" title="前面"></a>前面</h1><p>想起来去年在上家公司做的个小 Demo, 记录一下吧, 背景是当时食堂空间承受不住了, 大佬们组织了一场黑客马拉松, 实现摇号吃饭, 各个部门的大佬前后端开发设计师产品都组队参赛, 我当时所在的部门都在忙着产品上线没人愿意参加, 介于我逗比的潜质, 独自一人邀请了一个产品小伙伴组成了唯一一个只有两个人参赛的队伍…大概是花了2天时间完成…</p>
<p><strong>感谢我的产品小伙伴 @刘海滨, 点子都是他想的.</strong></p>
<p>初衷是, 每日推荐一个表情包, 然后大家进行模仿自拍, 匹配相似度. 进行排队吃饭. 大致效果图如下…惨不忍睹…</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/21/1607730eeb227377?w=375&amp;h=667&amp;f=gif&amp;s=2584477" alt="效果图"></p>
<h1 id="功能点"><a href="#功能点" class="headerlink" title="功能点"></a>功能点</h1><ul>
<li>AVFoundation 实现自拍的相机功能</li>
<li>基于 Vision 进行实时人脸追踪</li>
<li>拍照后基于 Vision 进行人脸特征点提取, 并且展示出来</li>
<li>表情包的特征点和自拍的特征点进行相似度匹配</li>
<li>对自拍进行剪裁, 表情包中的文字添加, 人脸磨皮美颜, 完成表情包制作, 分享.</li>
</ul>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="搭建项目"><a href="#搭建项目" class="headerlink" title="搭建项目"></a>搭建项目</h2><p>因为要使用 Vision 框架所以只能支持 iOS 11 及以上版本.</p>
<p>本来最开始是希望可以做完整的, 但是时间太少了, 只做了上面提到的这些功能, 功能少, 所以结构非常简单, 在”我”的和”我们的”两个标签下面内容几乎没有….</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/25/1608d0964120a1b7?w=1024&amp;h=768&amp;f=jpeg&amp;s=349406" alt="项目结构图"></p>
<p>那后面就只说一下核心功能的结构吧.</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/25/1608d09b666ef188?w=1024&amp;h=768&amp;f=jpeg&amp;s=142428" alt="核心功能结构"></p>
<p>从下至上, 短时间快速实现的简单的结构, 可能考虑不充分导致不是特别理想.</p>
<ul>
<li>人脸模型 : 封装 Vison 的人脸模型, 方便自己使用</li>
<li>人脸工具类 : 提供根据图片的人脸检测和特征点提取等方法</li>
<li>特征比较 : 提供两个特征的相似度比较</li>
<li>相机工具类 : 完整的处理相机的逻辑一直到拍好一张照片交给控制器</li>
<li>视图控制器 : 初始化相机工具类, 控制相机会话的启动和停止, 以及得到照片的得分和保存.</li>
</ul>
<p>下面是各个核心功能的一些实现过程.</p>
<h2 id="自定义相机"><a href="#自定义相机" class="headerlink" title="自定义相机"></a>自定义相机</h2><p>自定义相机这部分.走了一点弯路, 因为只支持 iOS 11, 原来熟悉的到处可以 Copy 的 AVFoundation 代码有一些 API 分别在 iOS 10 和 iOS 11 中被弃用了…我有看不惯弃用 API 的警告, 于是走上了填坑之路…</p>
<p>首先 <code>XYCaptureController.m</code> 为自拍的视图控制器, 我将相机的相关处理封装提取出来 <code>XYCaptureHelper.m</code> 好处是</p>
<ul>
<li>控制器逻辑简单, 算上空行也才100多行代码;</li>
<li>如果别的项目还需要相机可以直接拽过去稍微修改一下就能用了.</li>
</ul>
<p>在 <code>XYCaptureHelper.h</code> 中暴露最核心的方法是创建相机会话</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">在View上创建扫描会话</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setupCaptureSessionDisplayOnView:(<span class="built_in">UIView</span> *)captureView;</span><br></pre></td></tr></table></figure>
<p>方法实现先校验了一下权限, 感兴趣的可以看 <code>XYAuthUtil</code> 对权限和跳转设置界面的简单封装.</p>
<p>校验权限后, 创建相机会话分为三步</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">创建相机扫描视图</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setupCaptureOnView:(<span class="built_in">UIView</span> *)captureView &#123;</span><br><span class="line">    <span class="comment">//  弱引用父视图, 方便布局等其他控制</span></span><br><span class="line">    <span class="keyword">self</span>.captureView = captureView;</span><br><span class="line">    <span class="comment">//  创建相机会话</span></span><br><span class="line">    [<span class="keyword">self</span> setupCaptureSession];</span><br><span class="line">    <span class="comment">//  创建相机预览层</span></span><br><span class="line">    [<span class="keyword">self</span> setupCaptureDisplay];</span><br><span class="line">    <span class="comment">//  创建人脸预览层</span></span><br><span class="line">    [<span class="keyword">self</span> setupFacePreview   ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建相机会话"><a href="#创建相机会话" class="headerlink" title="创建相机会话"></a>创建相机会话</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupCaptureSession &#123;</span><br><span class="line"></span><br><span class="line">    _captureQueue = dispatch_queue_create(<span class="string">"com.hanyx.PassionForEating.Capture"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.session = [[<span class="built_in">AVCaptureSession</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.session.sessionPreset = <span class="built_in">AVCaptureSessionPresetPhoto</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.device = [<span class="keyword">self</span> cameraWithPostion:<span class="built_in">AVCaptureDevicePositionFront</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.input = [[<span class="built_in">AVCaptureDeviceInput</span> alloc] initWithDevice:<span class="keyword">self</span>.device error:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVCaptureVideoDataOutput</span> *dataOutput = [[<span class="built_in">AVCaptureVideoDataOutput</span> alloc] init];</span><br><span class="line">    [dataOutput setAlwaysDiscardsLateVideoFrames:<span class="literal">YES</span>];</span><br><span class="line">    [dataOutput setVideoSettings:@&#123;(<span class="keyword">id</span>)kCVPixelBufferPixelFormatTypeKey:@(kCVPixelFormatType_32BGRA)&#125;];</span><br><span class="line">    [dataOutput setSampleBufferDelegate:<span class="keyword">self</span> queue:_captureQueue];</span><br><span class="line">    <span class="keyword">self</span>.dataOutput = dataOutput;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.imageOutput = [[<span class="built_in">AVCapturePhotoOutput</span> alloc] init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.session canAddInput:<span class="keyword">self</span>.input]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.session addInput:<span class="keyword">self</span>.input];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.session canAddOutput:dataOutput]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.session addOutput:dataOutput];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.session canAddOutput:<span class="keyword">self</span>.imageOutput]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.session addOutput:<span class="keyword">self</span>.imageOutput];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVCaptureConnection</span> *connection = [dataOutput.connections firstObject];</span><br><span class="line">    [connection setVideoOrientation:<span class="built_in">AVCaptureVideoOrientationPortrait</span>];</span><br></pre></td></tr></table></figure>
<p>其实就是主流的写法, 获取相机设备, 根据设备创建输入, 输出对象, 都添加到相机会话中, 比较重要的是, 实现了 <code>AVCaptureVideoDataOutputSampleBufferDelegate</code> 代理, 来获得到相机捕获的缓冲帧信息.</p>
<p>关于 iOS 11 第一处不同是 <code>imageOutput</code> 之前我们习惯去使用 <code>AVCaptureStillImageOutput</code> 对象来获取相机拍摄的高清照片, 但是这个类在 iOS 10 中被弃用了, 需要使用 <code>AVCapturePhotoOutput</code> 对象代替.</p>
<h3 id="创建相机预览层"><a href="#创建相机预览层" class="headerlink" title="创建相机预览层"></a>创建相机预览层</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupCaptureDisplay &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  预览层的生成</span></span><br><span class="line">    <span class="keyword">self</span>.previewLayer = [[<span class="built_in">AVCaptureVideoPreviewLayer</span> alloc] initWithSession:<span class="keyword">self</span>.session];</span><br><span class="line">    <span class="keyword">self</span>.previewLayer.videoGravity = <span class="built_in">AVLayerVideoGravityResizeAspectFill</span>;</span><br><span class="line">    [<span class="keyword">self</span>.captureView.layer insertSublayer:<span class="keyword">self</span>.previewLayer atIndex:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建预览层主要要设置的就是显示的缩放模式, 和 UIView 的 contentMode 很相似提供了三种, 非常简单, 一看就明白了.我这里使用 <code>AVLayerVideoGravityResizeAspectFill</code> 保持缩放比例来填充视图, 防止出现黑边的情况. 因为在父视图中, 可能存在其他视图, 比如拍照按钮等等, 所以预览图层我这里插入到最底层</p>
<h3 id="创建人脸预览层"><a href="#创建人脸预览层" class="headerlink" title="创建人脸预览层"></a>创建人脸预览层</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupFacePreview &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *faceShape = [[<span class="built_in">CAShapeLayer</span> alloc] init];</span><br><span class="line">    faceShape.fillColor     = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">    faceShape.strokeColor   = [<span class="built_in">UIColor</span> colorNamed:COLOR_Main].CGColor;</span><br><span class="line">    faceShape.lineWidth     = <span class="number">1</span>;</span><br><span class="line">    [<span class="keyword">self</span>.captureView.layer addSublayer:faceShape];</span><br><span class="line">    <span class="keyword">self</span>.faceShapeLayer     = faceShape;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>人脸预览层我这里使用 <code>CAShapeLayer</code> 指定了一个橙色的颜色. 用来框柱人脸区域.</p>
<h3 id="会话控制"><a href="#会话控制" class="headerlink" title="会话控制"></a>会话控制</h3><p>可以发现. 预览层我都没有指定 <code>frame</code> 可能由于各种问题, 获取父视图的 <code>frame</code><br>可能并不如预期, 所以, 我在开始回话的地方, 进行了 <code>frame</code> 的获取和对预览层 <code>frame</code> 的设置</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startRunning &#123;</span><br><span class="line">    [<span class="keyword">self</span>.session startRunning];</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">//  计算各个视图的尺寸</span></span><br><span class="line">        <span class="keyword">self</span>.captureFrame = <span class="keyword">self</span>.captureView.frame;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stopRunning &#123;</span><br><span class="line">    [<span class="keyword">self</span>.session stopRunning];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCaptureFrame:(<span class="built_in">CGRect</span>)captureFrame &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CGRectEqualToRect</span>(_captureFrame, captureFrame)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    _captureFrame = captureFrame;</span><br><span class="line">    <span class="built_in">CGRect</span> bounds = (<span class="built_in">CGRect</span>)&#123;<span class="number">0</span>, <span class="number">0</span>, captureFrame.size.width, captureFrame.size.height&#125;;</span><br><span class="line">    <span class="keyword">self</span>.previewLayer.frame = bounds;</span><br><span class="line">    <span class="keyword">self</span>.faceShapeLayer.frame = bounds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个地方我创建了 <code>self.captureFrame</code> 的属性, 而不是直接使用 <code>self.captureView.frame</code> 是因为在捕获的过程中, 很多操作可能都需要该 <code>frame</code> 中的信息, 但是 <code>UIView</code> 的 <code>frame</code> 实际上只允许在主线程调用. 所以这里使用属性方便了操作.</p>
<h3 id="实时缓冲帧的获取"><a href="#实时缓冲帧的获取" class="headerlink" title="实时缓冲帧的获取"></a>实时缓冲帧的获取</h3><p>之前已经说过, 实现了 <code>AVCaptureVideoDataOutputSampleBufferDelegate</code> 代理, 来获得到相机捕获的缓冲帧信息.实现方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput didOutputSampleBuffer:(<span class="built_in">CMSampleBufferRef</span>)sampleBuffer fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以根据 <code>CMSampleBufferRef</code> 来获取到缓冲帧的图片, 图片是低质量的.</p>
<h3 id="拍照"><a href="#拍照" class="headerlink" title="拍照"></a>拍照</h3><p>因为照片输出对象换成了新的 <code>AVCapturePhotoOutput</code> 所以拍照部分也有所变化,</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)captureWithSender:(<span class="built_in">UIButton</span> *)sender &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  震动反馈</span></span><br><span class="line">    [<span class="keyword">self</span>.taptic impactOccurred];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVCaptureConnection</span> *con = [<span class="keyword">self</span>.imageOutput connectionWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</span><br><span class="line">    <span class="built_in">UIDeviceOrientation</span> curDeviceOrientation = [[<span class="built_in">UIDevice</span> currentDevice] orientation];</span><br><span class="line">    <span class="built_in">AVCaptureVideoOrientation</span> avcaptureOrientation = [<span class="keyword">self</span> avOrientationForDeviceOrientation:curDeviceOrientation];</span><br><span class="line">    [con setVideoOrientation:avcaptureOrientation];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.imageOutput capturePhotoWithSettings:[<span class="built_in">AVCapturePhotoSettings</span> photoSettings] delegate:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取连接, 提前设置了方向, 防止照出来的图片可能会旋转90°的问题. 拍照的过程也有变换, 原来使用 <code>AVCaptureStillImageOutput</code> 的时候很方便通过 <code>block</code> 的方式获取原图, 现在需要使用代理. 实现 <code>AVCapturePhotoCaptureDelegate</code> 代理, 当拍照成功时, 会调用如下方法来获取高清图片</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCapturePhotoOutput</span> *)output didFinishProcessingPhoto:(<span class="keyword">nonnull</span> <span class="built_in">AVCapturePhoto</span> *)photo error:(<span class="keyword">nullable</span> <span class="built_in">NSError</span> *)error &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSData</span> *imgData = photo.fileDataRepresentation;</span><br><span class="line">    <span class="built_in">UIImage</span> *img = [<span class="built_in">UIImage</span> imageWithData:imgData];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要多说一句的是, <code>AVCapturePhotoSettings</code> 我添加了一个属性, 通过懒加载的方式初始化来进行使用, 可是在第二次拍摄的时候就会导致崩溃, 因为 <code>AVCapturePhotoSettings</code> 对象不能重复使用, 所以我这里每次拍照的时候创建了一个对象.</p>
<p>关于自定义相机大概内容就是这么多, 接下来看如何使用 Vision 来对捕获到的缓冲帧进行人脸追踪.</p>
<h2 id="人脸追踪"><a href="#人脸追踪" class="headerlink" title="人脸追踪"></a>人脸追踪</h2><h3 id="如何根据一张照片获取人脸位置"><a href="#如何根据一张照片获取人脸位置" class="headerlink" title="如何根据一张照片获取人脸位置?"></a>如何根据一张照片获取人脸位置?</h3><p>我在 <code>XYFaceHelper</code> 中封装了如下方法, 根据图片 <code>CIImage</code> 获取一个人脸矩形区域 <code>CGRect</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 人脸矩形区域检测</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)detectFaceRectWithImage:(<span class="built_in">CIImage</span> *)image completion:(<span class="keyword">void</span>(^)(<span class="built_in">CGRect</span> faceRect))completion;</span><br></pre></td></tr></table></figure>
<p>内部实现其实就是调用了 Vision 框架, 简单看一下如何使用 Vision 框架.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 人脸矩形区域检测</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)detectFaceRectWithImage:(<span class="built_in">CIImage</span> *)image completion:(<span class="keyword">void</span> (^)(<span class="built_in">CGRect</span> faceRect))completion &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!image || !completion) &#123; <span class="keyword">return</span> ; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> imgW = image.extent.size.width;</span><br><span class="line">    <span class="built_in">CGFloat</span> imgH = image.extent.size.height;</span><br><span class="line">    </span><br><span class="line">    VNImageRequestHandler *vnHandler = [[VNImageRequestHandler alloc] initWithCIImage:image orientation:kCGImagePropertyOrientationUp options:@&#123;&#125;];</span><br><span class="line">    VNDetectFaceRectanglesRequest *request = [[VNDetectFaceRectanglesRequest alloc] initWithCompletionHandler:^(VNRequest * _Nonnull request, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSArray</span> *results = request.results;</span><br><span class="line">        <span class="keyword">if</span> (!results.count) &#123;</span><br><span class="line">            completion(<span class="built_in">CGRectZero</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  获取结果</span></span><br><span class="line">        VNFaceObservation *item = [<span class="keyword">self</span> biggestObservationInArray:results];</span><br><span class="line">        <span class="built_in">CGRect</span> rect = item.boundingBox;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  根据比例偏移量计算在 View 中的位置</span></span><br><span class="line">        <span class="built_in">CGFloat</span> x = rect.origin.x * imgW;</span><br><span class="line">        <span class="built_in">CGFloat</span> y = rect.origin.y * imgH;</span><br><span class="line">        <span class="built_in">CGFloat</span> w = rect.size.width * imgW;</span><br><span class="line">        <span class="built_in">CGFloat</span> h = rect.size.height * imgH;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  返回结果, 坐标系转换, y值翻转</span></span><br><span class="line">        <span class="built_in">CGRect</span> result = <span class="built_in">CGRectMake</span>(x, imgH - y - h, w, h);</span><br><span class="line">        completion(result);</span><br><span class="line">    &#125;];</span><br><span class="line">    [vnHandler performRequests:@[request] error:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于使用的逻辑很清晰:</p>
<ul>
<li>使用 <code>CIImage</code> 创建一个 <code>VNImageRequestHandler</code> 图片请求处理器</li>
<li>创建 <code>VNDetectFaceRectanglesRequest</code> 人脸矩形区域识别的请求</li>
<li>处理器 处理 请求.</li>
</ul>
<p>关于处理完成的 Block:</p>
<p>Vison 返回的结果是一个数组, 因为图片中可能会有多个人脸. 那么基于我们的需求, 我这里取人脸区域面积最大的人脸进行处理. 处理时, 有两点需要注意:</p>
<ol>
<li><p>Vison 的识别结果 <code>VNFaceObservation</code> 所返回的矩形区域实际上值都是相对于图片宽高的比例, 假设图片宽 1000 像素, 人脸区域宽 100 像素, 则返回的 <code>CGRect</code> 中 width 其实为 <strong>0.1</strong>, 我们需要乘以图片的宽 1000 才能得到人脸区域的宽 100.</p>
</li>
<li><p><code>CoreImage</code> 的坐标系和 <code>UIKit</code> 中的坐标系是不一样的, 相信使用过 <code>CoreImage</code> 的同学都了解, 在 <code>UIKit</code> 中, 坐标原点是在屏幕<strong>左上角</strong>, 在 <code>CoreImage</code> 中, 坐标原点是在屏幕<strong>左下角</strong>, 我这里希望坐标转换成熟悉的 <code>UIKit</code> 中的坐标系. 转换关系如图:</p>
</li>
</ol>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/25/1608d0e2abf60b9f?w=1024&amp;h=768&amp;f=jpeg&amp;s=118246" alt="坐标转换"></p>
<p>简单来说, 只有 Y 坐标需要转换, 记一个公式也可以 : <code>Y(UIKit) = 总高 - Y(CoreImage) - 区域高</code></p>
<p>这样已经封装好一个根据一张图片返回人脸矩形区域的方法了.非常简单. 那么我们只要获取到摄像头捕捉的图片, 然后调用刚刚封装好的方法就可以了.</p>
<h3 id="获取缓冲帧照片"><a href="#获取缓冲帧照片" class="headerlink" title="获取缓冲帧照片"></a>获取缓冲帧照片</h3><p>因为 Vision 框架需要的图片类型是 <code>CIImage</code>, 所以我这刚刚说的代理方法中, 直接通过缓冲帧获得一个 <code>CIImage</code> 的对象.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput didOutputSampleBuffer:(<span class="built_in">CMSampleBufferRef</span>)sampleBuffer fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection &#123;</span><br><span class="line"></span><br><span class="line">    CVPixelBufferRef pixelBuffer = (CVPixelBufferRef)<span class="built_in">CMSampleBufferGetImageBuffer</span>(sampleBuffer);</span><br><span class="line">    <span class="built_in">CIImage</span> *ciImage = [<span class="built_in">CIImage</span> imageWithCVPixelBuffer:pixelBuffer];</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    [XYFaceHelper detectFaceRectWithImage:image completion:^(<span class="built_in">CGRect</span> faceRect) &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    </span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实时显示人脸框"><a href="#实时显示人脸框" class="headerlink" title="实时显示人脸框"></a>实时显示人脸框</h3><p>获取到人脸的区域 <code>CGRect</code> 之后就非常简单了. 改变之前创建的人脸预览层 <code>CGShapeLayer</code> 的 <code>path</code> 即可.</p>
<p>因为前置摄像头看见的我们是镜子中的我们, 和现实中的我们是镜像关系, 所以相机捕获到照片后, 会做一个水平翻转, 所以</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  人脸检测</span></span><br><span class="line">[XYFaceHelper detectFaceRectWithImage:image completion:^(<span class="built_in">CGRect</span> faceRect) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGPathRef</span> path;</span><br><span class="line">    <span class="keyword">if</span> (faceRect.size.height &amp;&amp; faceRect.size.width) &#123;</span><br><span class="line">        <span class="comment">//  根据比例偏移量计算在 View 中的位置</span></span><br><span class="line">        <span class="built_in">CGFloat</span> x = faceRect.origin.x - offsetX;</span><br><span class="line">        <span class="built_in">CGFloat</span> y = faceRect.origin.y - offsetY;</span><br><span class="line">        <span class="built_in">CGFloat</span> w = faceRect.size.width;</span><br><span class="line">        <span class="built_in">CGFloat</span> h = faceRect.size.height;</span><br><span class="line">        <span class="comment">//  坐标系转换, 自拍 x 值翻转</span></span><br><span class="line">        <span class="built_in">CGRect</span> drawRect = <span class="built_in">CGRectMake</span>(viewW - x - w, y, w, h);</span><br><span class="line">        path = [<span class="built_in">UIBezierPath</span> bezierPathWithRoundedRect:drawRect cornerRadius:<span class="number">7</span>].CGPath;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  绘制人脸框框</span></span><br><span class="line">    <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="keyword">self</span>.faceShapeLayer.path = path;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h2 id="特征点提取"><a href="#特征点提取" class="headerlink" title="特征点提取"></a>特征点提取</h2><h2 id="相似度匹配"><a href="#相似度匹配" class="headerlink" title="相似度匹配"></a>相似度匹配</h2><h2 id="表情包制作"><a href="#表情包制作" class="headerlink" title="表情包制作"></a>表情包制作</h2>
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/05/02/helloworld/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="韩元旭's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        hanyx1992@sina.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/05/">五月 2018<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="https://weibo.com/hanyuanxu" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-weibo">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/hanyx1992" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>旭丶Joy
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
